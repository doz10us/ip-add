die() { printf %s "${@+$@$'\n'}" ; exit 1; }

if [ -n "$SSH_CONNECTION" ]; then         
	echo "SSH connection found"
	sship=$(echo $SSH_CONNECTION | awk -F " " '{ print $1 }')
	echo "Your IP is $sship and we're working with it"         
	if [ -f .ip-add.conf ]; then
		echo "Configuration file found"             
		cat .ip-add.conf | while read file
		do                     
			if [ -f $file ]; then                       
				echo "File $file found"                         
				if grep -Fq "$sship" $file; then
					echo "Allowing access... "                                 
					echo "allow from "$sship >> $file                                 
					echo "Done"
				fi                     
			else                         
				die "$file not exists"
			fi            
		done         
	else             
		die "Config file doesn't exist"
	fi         
	echo "All IP has been added" 
fi

echo -n "Requesting session list..."
who | sed 's/.*(\(.*\))/\1/' | grep -e "[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}" > .ip.remove
echo " Done"
if [ -f .ip-add.conf ]; then
	echo "Configuration file found"             
	cat .ip-add.conf | while read file
	do                     
		cat $file | awk '{ print $3 }' | while read ip
		do
			echo "Checking ip..."
			if [ -f .ip.remove ]; then
				if ! grep -Fq "$ip" .ip.remove ; then
					echo "Removing outdated lines..."
					sed -i "/$ip/d" "$file"
				fi
			fi
			echo "We're OK now"
		done
	done
fi
